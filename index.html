<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… â€” ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„</title>
<meta name="description" content="Ù…Ø´ØºÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…: ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ± Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø±Ù‘Ø§Ø¡ØŒ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©." />

<style>
  :root{ --bg:#071028; --card:#0b1624; --muted:#9fb4c9; --accent:#38bdf8; --surface:#071826; --radius:10px }
  *{box-sizing:border-box}
  body{margin:0;font-family:Tahoma, Arial, "Segoe UI", sans-serif;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
  header{background:#001025;padding:18px 14px;border-bottom:1px solid rgba(255,255,255,0.03)}
  header .top{display:flex;align-items:center;gap:12px;max-width:1100px;margin:0 auto}
  h1{margin:0;color:var(--accent);font-size:1.25rem}
  .langSwitch{margin-left:auto;display:flex;gap:8px}
  .container{max-width:1100px;margin:14px auto;padding:12px}
  .controls{display:grid;grid-template-columns:1fr 260px;gap:10px}
  @media(max-width:760px){.controls{grid-template-columns:1fr}}
  input,select,button{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--surface);color:#fff;font-size:15px}
  .surah{background:var(--card);padding:12px;margin:10px 0;border-radius:10px}
  .surah strong{display:block;font-size:1rem}
  audio{width:100%;margin-top:8px}
  a.link{color:var(--accent);text-decoration:none}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  footer{padding:14px;text-align:center;color:var(--muted);font-size:13px}
  .status{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);color:var(--muted);margin:8px 0}
  .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
  .controls .readerBlock{display:flex;flex-direction:column;gap:8px}
  .surahListHeader{display:flex;align-items:center;gap:10px}
  .checkbox{width:18px;height:18px}
  .failed{opacity:0.6}
</style>
</head>
<body>
<header>
  <div class="top">
    <h1 id="title">ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
    <div class="langSwitch" role="tablist" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ©">
      <button id="btn-ar" aria-selected="true">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
      <button id="btn-en" aria-selected="false">English</button>
    </div>
  </div>
  <p id="subtitle" style="margin:8px 0 0;color:var(--muted);text-align:center">ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† ÙƒØ§Ù…Ù„Ù‹Ø§ Ù…Ø¬Ø§Ù†Ù‹Ø§</p>
</header>

<main class="container">
  <div class="controls" role="region" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Øª">
    <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø© Ø£Ùˆ Ø±Ù‚Ù…" aria-label="Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø©" />
    <div class="readerBlock">
      <label for="readerSelect" class="visually-hidden">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
      <select id="readerSelect" aria-label="Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø§Ø±Ø¦"><option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option></select>
      <div class="row" style="justify-content:space-between">
        <div class="status" id="status">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆØ± ÙˆØ§Ù„Ù‚Ø±Ù‘Ø§Ø¡...</div>
        <div style="text-align:right">
          <button id="downloadPlaylist" class="link">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ M3U</button>
        </div>
      </div>
    </div>
  </div>

  <div class="surahListHeader" style="margin-top:12px">
    <label><input type="checkbox" id="selectAll" class="checkbox" aria-label="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"/> <span id="selectAllLabel">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</span></label>
    <div id="counts" class="status">â€”</div>
  </div>

  <div id="surahList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</main>

<footer>
  <div>Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØªÙŠ: mp3quran.net â€” Ø¹Ø±Ø¶ Ù„Ù„Ø¨Ø« ÙˆØ§Ù„ØªÙ†Ø²ÙŠÙ„ØŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¯ÙˆÙ† Ù…ÙˆØ§ÙÙ‚Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø±.</div>
</footer>

<script>
(async function(){
  const API_BASE = "https://mp3quran.net/api/v3";
  const readersAPI = API_BASE + "/reciters?language=all";
  const surahAPI = API_BASE + "/suwar";

  const readerSelect = document.getElementById('readerSelect');
  const surahListEl = document.getElementById('surahList');
  const searchEl = document.getElementById('search');
  const statusEl = document.getElementById('status');
  const downloadPlaylistBtn = document.getElementById('downloadPlaylist');
  const selectAllEl = document.getElementById('selectAll');
  const countsEl = document.getElementById('counts');

  const btnAr = document.getElementById('btn-ar');
  const btnEn = document.getElementById('btn-en');
  const titleEl = document.getElementById('title');
  const subtitleEl = document.getElementById('subtitle');
  const selectAllLabel = document.getElementById('selectAllLabel');

  let surahs = [], currentSurahs = [], currentServer = '', readers = [];
  let lang = localStorage.getItem('quran_lang') || 'ar';
  let lastReader = localStorage.getItem('quran_reader') || '';

  const T = {
    ar: {
      searchPlaceholder: 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø© (Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù…)',
      downloadingPlaylist: 'Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...',
      noSurahs: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙˆØ± Ù„Ø¹Ø±Ø¶Ù‡Ø§.',
      ready: 'Ø¬Ø§Ù‡Ø². Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…Ù‡Ø§.',
      selectAll: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„',
      play: 'ØªØ´ØºÙŠÙ„',
      download: 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©',
      openNew: 'ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©',
      results: n => `Ø¹Ø±Ø¶ ${n} Ù†ØªÙŠØ¬Ø©${n!==1? 'Ø§Øª':''}`
    },
    en: {
      searchPlaceholder: 'Search surah by name or number',
      downloadingPlaylist: 'Preparing playlist...',
      noSurahs: 'No surahs to show.',
      ready: 'Ready. Choose a surah or search by name.',
      selectAll: 'Select all',
      play: 'Play',
      download: 'Download surah',
      openNew: 'Open in new window',
      results: n => `${n} result${n!==1? 's':''}`
    }
  };

  function applyLang(){
    const t = T[lang] || T.ar;
    searchEl.placeholder = t.searchPlaceholder;
    selectAllLabel.textContent = t.selectAll;
    btnAr.setAttribute('aria-selected', lang==='ar');
    btnEn.setAttribute('aria-selected', lang==='en');
    titleEl.textContent = lang==='ar' ? 'ğŸ“– Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…' : 'ğŸ“– The Holy Quran';
    subtitleEl.textContent = lang==='ar' ? 'ØªØ´ØºÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¢Ù† ÙƒØ§Ù…Ù„Ù‹Ø§ Ù…Ø¬Ø§Ù†Ù‹Ø§' : 'Stream and download the full Quran free';
    localStorage.setItem('quran_lang', lang);
  }

  btnAr.addEventListener('click', ()=>{ lang='ar'; applyLang(); render(currentSurahs,currentServer); });
  btnEn.addEventListener('click', ()=>{ lang='en'; applyLang(); render(currentSurahs,currentServer); });

  function setStatus(text){ statusEl.textContent = text; }

  function pad(n){ return String(n).padStart(3,'0'); }

  function normalizeText(t){ return (t||'').toString().toLowerCase().trim(); }

  function joinServer(server, name){ if(!server) return name; return server.endsWith('/') ? server + name : server + '/' + name; }

  async function fetchJSON(url){ const res = await fetch(url); if(!res.ok) throw new Error(res.status+' '+res.statusText); return res.json(); }

  try{
    const sdata = await fetchJSON(surahAPI);
    surahs = sdata.suwar || [];
    setStatus('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ± Ø¬Ø§Ù‡Ø²Ø©. Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ø±Ù‘Ø§Ø¡...');
  }catch(err){ surahListEl.innerHTML = `<div class='status'>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.</div>`; setStatus('Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±: '+err.message); console.error(err); return; }

  try{
    const rdata = await fetchJSON(readersAPI);
    readers = rdata.reciters || [];
    readerSelect.innerHTML = '';
    readers.forEach(r=>{
      const o = document.createElement('option'); o.value = r.id; o.textContent = (r.name || r.id) + (r.language ? ' â€” '+r.language : '');
      readerSelect.appendChild(o);
    });
    // select lastReader if present
    if(lastReader && Array.from(readerSelect.options).some(o=>o.value===lastReader)){ 
      readerSelect.value = lastReader;
    } else if(readerSelect.options.length){ readerSelect.value = readerSelect.options[0].value; }
    await loadReader();
    applyLang();
    setStatus(T[lang].ready);
  }catch(err){ surahListEl.innerHTML = `<div class='status'>ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ù‘Ø§Ø¡. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.</div>`; setStatus('Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡: '+err.message); console.error(err); return; }

  readerSelect.addEventListener('change', async ()=>{ localStorage.setItem('quran_reader', readerSelect.value); lastReader = readerSelect.value; await loadReader(); });
  searchEl.addEventListener('input', filterSurahs);
  downloadPlaylistBtn.addEventListener('click', downloadM3U);
  selectAllEl.addEventListener('change', ()=>{
    const checked = selectAllEl.checked; document.querySelectorAll('.surah input[type="checkbox"]').forEach(cb=>cb.checked = checked);
  });

  async function loadReader(){
    try{
      setStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦...');
      surahListEl.innerHTML = `<div class='status'>Ø¬Ø§Ø±Ù ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ø±Ø¦...</div>`;
      const rid = readerSelect.value; if(!rid) return;
      const url = `${API_BASE}/reciters?reciter=${encodeURIComponent(rid)}&language=all`;
      const data = await fetchJSON(url);
      const rec = data.reciters && data.reciters[0];
      if(!rec || !rec.moshaf || !rec.moshaf[0]){ surahListEl.innerHTML = `<div class='status'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ØµØ­Ù Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø§Ø±Ø¦.</div>`; currentSurahs = []; return; }
      const m = rec.moshaf[0];
      const server = m.server || '';
      currentServer = server;
      const available = new Set(m.surah_list || []);
      currentSurahs = surahs.map(s=>({ ...s, available: available.has(s.id) }));
      render(currentSurahs, server);
      setStatus((lang==='ar' ? 'Ø¹Ø±Ø¶' : 'Showing') + ' ' + currentSurahs.length + ' â€” Ø§Ù„Ù‚Ø§Ø±Ø¦: ' + (rec.name||rid));
    }catch(err){ surahListEl.innerHTML = `<div class='status'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦.</div>`; setStatus('Ø®Ø·Ø£: '+err.message); console.error(err); }
  }

  function render(list, server){
    if(!list || list.length===0){ surahListEl.innerHTML = `<div class='status'>${T[lang].noSurahs}</div>`; countsEl.textContent = '' ; return; }
    surahListEl.innerHTML = '';
    list.forEach(s=>{
      const n = pad(s.id); const filename = n + '.mp3'; const url = joinServer(server, filename);
      const div = document.createElement('div'); div.className = 'surah'; if(!s.available) div.classList.add('failed');
      const enName = s.en_name || s.english_name || s.transliteration || s.name;
      const title = lang==='ar' ? `${s.name} â€” Ø±Ù‚Ù… ${s.id} â€¢ Ø¢ÙŠØ§Øª ${s.ayat_count||'-'}` : `${enName} â€” No. ${s.id} â€¢ Ayahs ${s.ayat_count||'-'}`;
      div.innerHTML = `
        <label style="display:flex;align-items:center;gap:8px"><input type=checkbox class=checkbox ${s.available ? '' : 'disabled'} aria-label="Ø§Ø®ØªØ± ${s.name}"/> <strong>${title}</strong></label>
        <audio controls preload="none" data-src="${url}"></audio>
        <div class="row">
          <a href="${url}" download class="link">â¬‡ï¸ ${T[lang].download}</a>
          <a class="link" href="${url}" target="_blank" rel="noopener">â–¶ï¸ ${T[lang].openNew}</a>
          <button class="link btn-play" data-src="${url}">${T[lang].play}</button>
        </div>
      `;
      surahListEl.appendChild(div);
      const audio = div.querySelector('audio'); audio.src = url;
      audio.addEventListener('error', ()=>handleAudioError(audio, s, server));
      const playBtn = div.querySelector('.btn-play'); playBtn.addEventListener('click', ()=>{ audio.play().catch(()=>{}); });
    });
    countsEl.textContent = `${list.length} / ${surahs.length}`;
  }

  function handleAudioError(audio, surah, server){
    // mark as failed and try a simple fallback: try without leading zero padding if any
    const orig = audio.dataset.src || audio.src;
    let tried = audio.dataset.tried || '';
    if(tried === 'alt1'){
      audio.closest('.surah').classList.add('failed');
      console.warn('Failed to load', orig);
      return;
    }
    // try alternate filename without zero padding (e.g., 01.mp3 -> 1.mp3)
    const altName = surah.id + '.mp3';
    const altUrl = joinServer(server, altName);
    if(altUrl !== orig){ audio.dataset.tried = 'alt1'; audio.src = altUrl; audio.load(); }
    else { audio.closest('.surah').classList.add('failed'); }
  }

  function filterSurahs(){
    const q = normalizeText(searchEl.value);
    if(!q){ render(currentSurahs, currentServer); setStatus(T[lang].results(currentSurahs.length)); return; }
    const filtered = currentSurahs.filter(s=> normalizeText(s.name).includes(q) || (s.en_name && normalizeText(s.en_name).includes(q)) || String(s.id).includes(q));
    render(filtered, currentServer); setStatus(T[lang].results(filtered.length));
  }

  function downloadM3U(){
    const checked = Array.from(document.querySelectorAll('.surah input[type=checkbox]')).filter(cb=>cb.checked);
    const audioEls = checked.map(cb => cb.closest('.surah').querySelector('audio')).filter(a=>a && a.src);
    if(audioEls.length===0){ alert(lang==='ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙˆØ± Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„ØªÙ†Ø²ÙŠÙ„.' : 'No surahs selected.'); return; }
    const lines = ['#EXTM3U']; audioEls.forEach(a=>lines.push(a.src));
    const blob = new Blob([lines.join('\n')], {type:'audio/x-mpegurl'}); const name = 'quran_playlist.m3u'; const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

})();
</script>

</body>
</html>
